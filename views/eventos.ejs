<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Eventos</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700;900&family=Inter:wght@300;400;600&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="/css/admin-styles.css">
    </style>
</head>

<body>

    <div class="header">
        <div class="header-left">
            <a href="/" class="btn-back">‚Üê Volver al Men√∫</a>
            <div class="header-title">üìÖ Administrador de Eventos</div>
        </div>
        <a href="/logout" class="btn-logout">üö™ Cerrar Sesi√≥n</a>
    </div>

    <div class="container">
        <div id="alert" class="alert"></div>

        <div class="filters-container">
            <div class="search-bar">
                <div class="search-input-wrapper">
                    <input type="text" id="searchInput" class="search-input"
                        placeholder="üîç Buscar por nombre del evento...">
                </div>
                <button class="btn-clear" onclick="clearFilters()">üîÑ Limpiar Filtros</button>
            </div>

            <div class="filters-row">
                <div class="filter-group">
                    <label for="filterID">ID del Evento</label>
                    <input type="text" id="filterID" class="filter-input" placeholder="Buscar por ID...">
                </div>

                <div class="filter-group">
                    <label for="filterFechaDesde">Fecha Desde</label>
                    <input type="date" id="filterFechaDesde" class="filter-input">
                </div>

                <div class="filter-group">
                    <label for="filterFechaHasta">Fecha Hasta</label>
                    <input type="date" id="filterFechaHasta" class="filter-input">
                </div>

                <div class="filter-group">
                    <label for="filterEstado">Filtrar por Estado</label>
                    <select id="filterEstado" class="filter-select">
                        <option value="">Todos los estados</option>
                        <option value="1">Activo</option>
                        <option value="0">Inactivo</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="results-info">
            Mostrando <strong id="resultCount">0</strong> de <strong id="totalCount">0</strong> eventos
        </div>

        <div class="pagination-container" id="paginationTop"></div>

        <div class="table-wrapper">
            <div id="loadingIndicator" class="loading">Cargando eventos</div>

            <table id="eventosTable" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nombre</th>
                        <th>Departamento</th>
                        <th>Municipio</th>
                        <th>Fecha Inicio</th>
                        <th>Cadena</th>
                        <th>Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody id="eventosTableBody">
                </tbody>
            </table>

            <div id="noResults" class="no-results" style="display: none;">
                No se encontraron eventos que coincidan con tu b√∫squeda
            </div>
        </div>

        <div class="pagination-container" id="paginationBottom"></div>
    </div>

    <div id="editModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>Editar Evento</h2>

            <form id="editForm">
                <input type="hidden" id="eventId">
                <input type="hidden" id="currentDeptoId">
                <input type="hidden" id="currentEspcadId">

                <div class="form-group">
                    <label>Departamento:</label>
                    <div class="field-type-toggle">
                        <button type="button" class="type-btn active"
                            onclick="setDepartamentoType('departamento')">Departamento</button>
                    </div>
                    <select id="departamento" style="display: block;">
                        <option value="">Seleccione un departamento...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Cadena:</label>
                    <div class="field-type-toggle">
                        <button type="button" class="type-btn active" onclick="setCadenaType('cadena')">Cadena</button>
                    </div>
                    <select id="cadena" style="display: block;">
                        <option value="">Seleccione una cadena...</option>
                    </select>
                </div>

                <button type="submit" class="btn-save">üíæ Guardar Cambios</button>
            </form>
        </div>
    </div>

    <script>
        let currentPage = 1;
        let currentLimit = 20;
        let totalPages = 1;
        let totalCount = 0;
        let isLoading = false;
        let currentDepartamentoType = 'departamento';
        let currentCadenaType = 'cadena';
        let searchTimeout;

        document.addEventListener('DOMContentLoaded', function () {
            loadEventos();

            document.getElementById('searchInput').addEventListener('input', function () {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 1;
                    loadEventos();
                }, 500);
            });

            document.getElementById('filterID').addEventListener('input', function () {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 1;
                    loadEventos();
                }, 500);
            });

            document.getElementById('filterFechaDesde').addEventListener('change', () => {
                currentPage = 1;
                loadEventos();
            });

            document.getElementById('filterFechaHasta').addEventListener('change', () => {
                currentPage = 1;
                loadEventos();
            });

            document.getElementById('filterEstado').addEventListener('change', () => {
                currentPage = 1;
                loadEventos();
            });
        });

        async function loadEventos() {
            if (isLoading) return;

            isLoading = true;
            showLoading();

            try {
                const params = new URLSearchParams({
                    page: currentPage,
                    limit: currentLimit,
                    searchText: document.getElementById('searchInput').value,
                    filterID: document.getElementById('filterID').value,
                    filterFechaDesde: document.getElementById('filterFechaDesde').value,
                    filterFechaHasta: document.getElementById('filterFechaHasta').value,
                    filterEstado: document.getElementById('filterEstado').value
                });

                const res = await fetch(`/eventos/api/eventos?${params}`);
                const data = await res.json();

                if (data.success) {
                    totalPages = data.totalPages;
                    totalCount = data.totalCount;
                    renderEventos(data.eventos);
                    renderPagination();
                    updateResultsInfo(data.eventos.length, totalCount);
                } else {
                    showAlert('Error al cargar eventos', 'error');
                }
            } catch (err) {
                console.error('Error:', err);
                showAlert('Error al cargar eventos', 'error');
            } finally {
                isLoading = false;
                hideLoading();
            }
        }

        function renderEventos(eventos) {
            const tbody = document.getElementById('eventosTableBody');
            tbody.innerHTML = '';

            if (eventos.length === 0) {
                document.getElementById('eventosTable').style.display = 'none';
                document.getElementById('noResults').style.display = 'block';
                return;
            }

            document.getElementById('eventosTable').style.display = 'table';
            document.getElementById('noResults').style.display = 'none';

            eventos.forEach(evento => {
                const estadoTexto = evento.event_estado === 1 ? 'Activo' : 'Inactivo';
                const estadoClass = evento.event_estado === 1 ? 'status-active' : 'status-inactive';

                const tr = document.createElement('tr');
                tr.innerHTML = `
            <td>${evento.event_id}</td>
            <td>${evento.event_nombre}</td>
            <td>${evento.event_depto_desc || 'N/A'}</td>
            <td>${evento.event_munic_desc}</td>
            <td>${new Date(evento.event_fec_inicio).toLocaleDateString()}</td>
            <td>${evento.esca_esp_desc || 'N/A'}</td>
            <td><span class="status-badge ${estadoClass}">${estadoTexto}</span></td>
            <td>
                <button class="btn-edit" 
                        data-event-id="${evento.event_id}"
                        data-dep-id="${evento.event_depto_id || ''}"
                        data-dep-desc="${evento.event_depto_desc || ''}"
                        data-espcad-id="${evento.espcad_id || ''}"
                        data-cadena-desc="${evento.esca_esp_desc || ''}"
                        onclick="openModalFromButton(this)">
                    ‚úèÔ∏è Editar
                </button>
            </td>
        `;
                tbody.appendChild(tr);
            });
        }

        function renderPagination() {
            const paginationHTML = createPaginationHTML();
            document.getElementById('paginationTop').innerHTML = paginationHTML;
            document.getElementById('paginationBottom').innerHTML = paginationHTML;
        }

        function createPaginationHTML() {
            if (totalPages <= 1) return '';

            let html = '<div class="pagination-buttons">';

            html += `<button class="page-btn" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
        ‚Üê Anterior
    </button>`;

            const pagesToShow = getPagesToShow();
            pagesToShow.forEach(page => {
                if (page === '...') {
                    html += `<span class="page-btn" disabled>...</span>`;
                } else {
                    html += `<button class="page-btn ${page === currentPage ? 'active' : ''}" 
                            onclick="changePage(${page})">
                ${page}
            </button>`;
                }
            });

            html += `<button class="page-btn" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
        Siguiente ‚Üí
    </button>`;

            html += '</div>';

            html += `<div class="page-limit">
        <label>Mostrar:</label>
        <select onchange="changeLimit(this.value)">
            <option value="10" ${currentLimit === 10 ? 'selected' : ''}>10</option>
            <option value="20" ${currentLimit === 20 ? 'selected' : ''}>20</option>
            <option value="50" ${currentLimit === 50 ? 'selected' : ''}>50</option>
            <option value="100" ${currentLimit === 100 ? 'selected' : ''}>100</option>
        </select>
    </div>`;

            html += `<div class="pagination-info">P√°gina ${currentPage} de ${totalPages}</div>`;

            return html;
        }

        function getPagesToShow() {
            const pages = [];
            const maxVisible = 7;

            if (totalPages <= maxVisible) {
                for (let i = 1; i <= totalPages; i++) {
                    pages.push(i);
                }
            } else {
                if (currentPage <= 4) {
                    for (let i = 1; i <= 5; i++) pages.push(i);
                    pages.push('...');
                    pages.push(totalPages);
                } else if (currentPage >= totalPages - 3) {
                    pages.push(1);
                    pages.push('...');
                    for (let i = totalPages - 4; i <= totalPages; i++) pages.push(i);
                } else {
                    pages.push(1);
                    pages.push('...');
                    for (let i = currentPage - 1; i <= currentPage + 1; i++) pages.push(i);
                    pages.push('...');
                    pages.push(totalPages);
                }
            }

            return pages;
        }

        function changePage(page) {
            if (page < 1 || page > totalPages || page === currentPage) return;
            currentPage = page;
            loadEventos();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function changeLimit(newLimit) {
            currentLimit = parseInt(newLimit);
            currentPage = 1;
            loadEventos();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('filterID').value = '';
            document.getElementById('filterFechaDesde').value = '';
            document.getElementById('filterFechaHasta').value = '';
            document.getElementById('filterEstado').value = '';
            currentPage = 1;
            loadEventos();
        }

        function updateResultsInfo(showing, total) {
            document.getElementById('resultCount').textContent = showing;
            document.getElementById('totalCount').textContent = total;
        }

        function showLoading() {
            document.getElementById('loadingIndicator').style.display = 'block';
            document.getElementById('eventosTable').style.display = 'none';
            document.getElementById('noResults').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loadingIndicator').style.display = 'none';
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = 'alert alert-' + type;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 4000);
        }

        function setDepartamentoType(type) {
            currentDepartamentoType = type;
            const deptoSelect = document.getElementById('departamento');
            const formGroup = deptoSelect.closest('.form-group');
            const buttons = formGroup.querySelectorAll('.type-btn');

            buttons.forEach(btn => btn.classList.remove('active'));

            if (type === 'departamento') {
                deptoSelect.style.display = 'block';
                if (buttons[0]) buttons[0].classList.add('active');
            }
        }

        function setCadenaType(type) {
            currentCadenaType = type;
            const cadenaSelect = document.getElementById('cadena');
            const formGroup = cadenaSelect.closest('.form-group');
            const buttons = formGroup.querySelectorAll('.type-btn');

            buttons.forEach(btn => btn.classList.remove('active'));

            if (type === 'cadena') {
                cadenaSelect.style.display = 'block';
                if (buttons[0]) buttons[0].classList.add('active');
            }
        }

        async function loadDepartamentos() {
            const select = document.getElementById("departamento");
            select.innerHTML = `<option value="">Cargando departamentos...</option>`;

            try {
                const res = await fetch("/eventos/api/departamentos");
                if (!res.ok) throw new Error('Error al cargar departamentos');

                const departamentos = await res.json();

                select.innerHTML = `<option value="">Seleccione un departamento...</option>`;
                departamentos.forEach(dep => {
                    const option = document.createElement("option");
                    option.value = dep.dep_id.toString();
                    option.textContent = dep.dep_desc;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Error cargando departamentos:', err);
                select.innerHTML = `<option value="">Error al cargar departamentos</option>`;
                showAlert("Error al cargar departamentos", "error");
            }
        }

        async function loadCadenas() {
            const select = document.getElementById("cadena");
            select.innerHTML = `<option value="">Cargando cadenas...</option>`;

            try {
                const res = await fetch("/eventos/api/cadenas");
                if (!res.ok) throw new Error('Error al cargar cadenas');

                const cadenas = await res.json();

                select.innerHTML = `<option value="">Seleccione una cadena...</option>`;
                cadenas.forEach(cad => {
                    const option = document.createElement("option");
                    option.value = cad.espcad_id.toString();
                    option.textContent = cad.espcad_cad_desc;
                    select.appendChild(option);
                });
            } catch (err) {
                console.error('Error cargando cadenas:', err);
                select.innerHTML = `<option value="">Error al cargar cadenas</option>`;
                showAlert("Error al cargar cadenas", "error");
            }
        }

        async function openModalFromButton(button) {
            const eventId = button.dataset.eventId;
            const depIdActual = button.dataset.depId;
            const depDescActual = button.dataset.depDesc;
            const espcadIdActual = button.dataset.espcadId;
            const cadenaDescActual = button.dataset.cadenaDesc;

            document.getElementById("eventId").value = eventId;
            document.getElementById("currentDeptoId").value = depIdActual || '';
            document.getElementById("currentEspcadId").value = espcadIdActual || '';
            document.getElementById("editModal").style.display = "block";

            try {
                await loadDepartamentos();
                await loadCadenas();

                await new Promise(resolve => setTimeout(resolve, 500));

                if (depIdActual && depIdActual !== '' && depIdActual !== 'null') {
                    setDepartamentoType('departamento');
                    const deptoSelect = document.getElementById("departamento");
                    if (deptoSelect) {
                        deptoSelect.value = depIdActual.toString();
                    }
                }

                if (espcadIdActual && espcadIdActual !== '' && espcadIdActual !== 'null') {
                    setCadenaType('cadena');
                    const cadenaSelect = document.getElementById("cadena");
                    if (cadenaSelect) {
                        cadenaSelect.value = espcadIdActual.toString();
                    }
                }
            } catch (error) {
                console.error('Error al cargar datos del modal:', error);
                showAlert("Error al cargar los datos. Verifique la conexi√≥n.", "error");
            }
        }

        function closeModal() {
            document.getElementById("editModal").style.display = "none";
        }

        window.onclick = function (e) {
            if (e.target === document.getElementById("editModal")) closeModal();
        };

        document.getElementById("editForm").addEventListener("submit", async function (e) {
            e.preventDefault();

            const eventId = document.getElementById("eventId").value;
            const currentDeptoId = document.getElementById("currentDeptoId").value;
            const currentEspcadId = document.getElementById("currentEspcadId").value;
            const deptoId = document.getElementById("departamento").value;
            const espcadId = document.getElementById("cadena").value;

            const finalDeptoId = deptoId || currentDeptoId || null;
            const finalEspcadId = espcadId || currentEspcadId || null;

            try {
                const res = await fetch(`/eventos/api/${eventId}`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        event_depto_id: finalDeptoId,
                        espcad_id: finalEspcadId
                    })
                });

                const data = await res.json();

                if (data.success) {
                    showAlert("Evento actualizado exitosamente", "success");
                    closeModal();
                    setTimeout(() => loadEventos(), 800);
                } else {
                    showAlert(data.message || "Error al actualizar evento", "error");
                }
            } catch (err) {
                console.error('Error al guardar:', err);
                showAlert("Error al guardar cambios", "error");
            }
        });
    </script>

</body>

</html>